@* TopicsSidebar.razor — self-contained sidebar (desktop) / drawer (mobile) + NEW TOPIC MODAL *@
@using System.Linq
@using System.Security.Claims
@using LevelForum.Data.Entities
@using LevelForum.Data.Services
@using LevelForum.Infrastructure
@implements IDisposable

@inject TopicService _topicService
@inject TopicFollowService _followService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<nav class="tsb @(_open ? "is-open" : null)" aria-label="Topics navigation">
  <div class="tsb-overlay" @onclick="CloseDrawer" aria-hidden="@(!_open)"></div>

  <div class="tsb-panel" role="navigation" aria-label="Topics">
    <div class="tsb-header on-mobile">
      <div class="title">Topics</div>
      <button class="icon-btn" aria-label="Close" @onclick="CloseDrawer">✕</button>
    </div>

    <div class="tsb-inner">
      @if (!string.IsNullOrEmpty(_error))
      {
        <div class="tsb-alert">@_error</div>
      }

      <div class="tsb-section followed">
        <div class="tsb-section-title">Followed</div>
        @if (_followed is not null && _followed.Any())
        {
          @foreach (var t in _followed)
          {
            <div class="tsb-item @(t.Id==_activeTopicId?"is-active":null)"
                 role="button" tabindex="0" title="@t.Title"
                 @onclick="() => NavigateToTopic(t.Id)">
              <span class="tsb-bullet">★</span>
              <span class="tsb-label">@t.Title</span>
              <span class="tsb-action" @onclick:stopPropagation="true">
                <button class="pill"
                        disabled="@_busy.Contains(t.Id)"
                        title="Unfollow"
                        @onclick="() => UnfollowAsync(t.Id)">−</button>
              </span>
            </div>
          }
        }
        else if (_loading)
        {
          <div class="tsb-skel">Loading…</div>
        }
        else
        {
          <div class="tsb-empty">You don't follow any topics yet.</div>
        }
      </div>

      <div class="tsb-section popular">
        <div class="tsb-section-title">Popular Topics</div>
        @if (_all?.Any() == true)
        {
          @foreach (var t in _all)
          {
            <div class="tsb-item @(t.Id==_activeTopicId?"is-active":null)"
                 role="button" tabindex="0" title="@t.Title"
                 @onclick="() => NavigateToTopic(t.Id)">
              <span class="tsb-bullet">•</span>
              <span class="tsb-label">@t.Title</span>
              <span class="tsb-action" @onclick:stopPropagation="true">
                @if (t.IsFollowed)
                {
                  <button class="pill"
                          disabled="@_busy.Contains(t.Id)"
                          title="Unfollow"
                          @onclick="() => UnfollowAsync(t.Id)">−</button>
                }
                else
                {
                  <button class="pill"
                          disabled="@_busy.Contains(t.Id)"
                          title="Follow"
                          @onclick="() => FollowAsync(t.Id)">＋</button>
                }
              </span>
            </div>
          }
        }
        else if (_loading)
        {
          <div class="tsb-skel">Loading…</div>
        }
        else
        {
          <div class="tsb-empty">No topics yet.</div>
        }
      </div>

      <div class="tsb-footer">
        <button class="link as-btn" @onclick="OpenCreateModal">+ New Topic</button>
      </div>
    </div>
  </div>
</nav>

@* =========================
   FULLSCREEN CREATE TOPIC MODAL
   ========================= *@
@if (_showCreate)
{
  <div class="modal-root" @onkeydown="HandleModalKey">
    <div class="modal-backdrop" @onclick="CloseCreateModal"></div>
    <div class="modal-sheet" role="dialog" aria-modal="true" aria-label="Create a new topic">
      <div class="modal-header">
        <div class="mh-title">Create Topic</div>
        <button class="icon-btn" title="Close" @onclick="CloseCreateModal">✕</button>
      </div>

      <div class="modal-body">
        @if (!string.IsNullOrEmpty(_createError))
        {
          <div class="alert error">@_createError</div>
        }

        <div class="form-row">
          <label class="lbl">Title<span class="req">*</span></label>
          <input class="input"
                 placeholder="e.g. C# Tips, EF Core, Frontend Design"
                 @bind="_newTitle" @bind:event="oninput"
                 maxlength="@TitleMax" />
          <div class="help">
            <span>@(_newTitle?.Length ?? 0)/@TitleMax</span>
          </div>
        </div>

        <div class="form-row">
          <label class="lbl">Description <span class="muted">(optional)</span></label>
          <textarea class="textarea"
                    placeholder="Short description of the topic…"
                    @bind="_newDesc" @bind:event="oninput"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" @onclick="CloseCreateModal" disabled="@_saving">Cancel</button>
        <button class="btn-primary"
                @onclick="CreateTopicAsync"
                disabled="@(!_canCreate || _saving)">
          @(_saving ? "Creating…" : "Create")
        </button>
      </div>
    </div>
  </div>
}

<style>
  /* ====== DESKTOP (default) ====== */
  .tsb { position: sticky; top:56px; height:calc(100vh - 56px); z-index:10; }
  .tsb-overlay { display:none; }

  .tsb-panel {
    width:72px; height:100%;
    border-right:1px solid rgba(255,255,255,.06);
    background:var(--surface,#151923);
    transition:width .18s ease;
    box-sizing:border-box;
    overflow:hidden;
  }
  .tsb:hover .tsb-panel { width:280px; }

  .tsb-inner{ height:100%; display:flex; flex-direction:column; gap:8px; padding:8px; min-height:0; }
  .tsb-header.on-mobile{ display:none }

  .tsb-section{ display:flex; flex-direction:column; gap:4px; }
  .tsb-section-title{ color:var(--muted,#9aa3b2); font-size:12px; padding:8px 6px }
  .tsb-item{ width:100%; display:flex; align-items:center; gap:10px; background:transparent; border:none; color:inherit;
    border-radius:10px; padding:8px; cursor:pointer; position:relative; }
  .tsb-item:hover{ background:rgba(255,255,255,.06) }
  .tsb-bullet{ width:22px; text-align:center; opacity:.8 }
  .tsb-label{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; opacity:0; transition:opacity .18s }
  .tsb:hover .tsb-label{ opacity:1 }
  .tsb-action{ opacity:0; transition:opacity .18s }
  .tsb:hover .tsb-action{ opacity:1 }
  .tsb-item.is-active{ outline:2px solid rgba(79,70,229,.45) }

  .pill{ min-width:24px; height:24px; padding:0 6px; border-radius:999px; border:1px solid rgba(255,255,255,.1);
    background:transparent; color:inherit; cursor:pointer }
  .pill:disabled{ opacity:.5; cursor:not-allowed }
  .pill:hover:not(:disabled){ background:rgba(255,255,255,.06) }

  .tsb-footer{ margin-top:auto; padding:8px }
  .link{ color:var(--text); opacity:.9; text-decoration:none }
  .link.as-btn{ background:transparent; border:none; padding:0; cursor:pointer; font:inherit; color:var(--text); }

  .tsb-skel, .tsb-empty, .tsb-alert{
    margin:6px 8px; font-size:12px; color:var(--muted,#9aa3b2);
  }
  .tsb-alert{ color:#ffd1d1 }

  /* FOLLOWED: max 40%, bez skrola dok nije proširen */
  .tsb-section.followed {
    flex: 0 1 auto;
    max-height: 40%;
    min-height: 0;
    overflow-y: hidden;
    overflow-x: hidden;
  }
  .tsb:hover .tsb-section.followed {
    overflow-y: auto;
  }
  .tsb-section.followed .tsb-section-title {
    position: sticky; top: 0;
    background: var(--surface,#151923);
    z-index: 1;
  }

  /* POPULAR: max 50%, isto ponašanje kao followed */
  .tsb-section.popular {
    flex: 0 1 auto;
    max-height: 50%;
    min-height: 0;
    overflow-y: hidden;
    overflow-x: hidden;
  }
  .tsb:hover .tsb-section.popular {
    overflow-y: auto;
  }
  .tsb-section.popular .tsb-section-title {
    position: sticky; top: 0;
    background: var(--surface,#151923);
    z-index: 1;
  }

  @@media (hover: none) {
    .tsb-label { opacity:1; }
    .tsb-action{ opacity:1; }
  }

  @@media (max-width: 960px) {
    .tsb { position: static; z-index:60; }

    .tsb-panel {
      position: fixed;
      inset: 0 auto 0 0;
      width: min(90vw, 360px);
      height: 100vh;
      transform: translateX(-100%);
      transition: transform .2s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      border-right: 1px solid rgba(255,255,255,.06);
      z-index: 61;
      overflow:hidden;
    }
    .tsb.is-open .tsb-panel { transform: translateX(0); }

    .tsb-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      z-index: 60;
    }
    .tsb.is-open .tsb-overlay { display: block; }

    .tsb-header.on-mobile {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px; border-bottom:1px solid rgba(255,255,255,.06)
    }

    .tsb-inner {
      padding: 8px;
      height: calc(100vh - 52px);
      overflow: hidden;
      min-height: 0;
    }
    
    .tsb-section.followed,
    .tsb-section.popular {
      overflow: auto;
    }
    
    .tsb-section.followed { max-height: 40%; }
    .tsb-section.popular  { max-height: 50%; }

    .tsb-label { opacity:1; }
    .tsb-action{ opacity:1; }

    .tsb-section.popular { overflow:auto; }
  }

  .modal-root{
    position:fixed; inset:0; z-index:1000;
  }
  .modal-backdrop{
    position:absolute; inset:0;
    background:rgba(0,0,0,.55);
    z-index:0;
    pointer-events:auto;
  }
  .modal-sheet{
    position:absolute; inset:0;
    display:flex; flex-direction:column;
    background:var(--surface,#151923);
    border:1px solid rgba(255,255,255,.08);
    z-index:1;
    pointer-events:auto;
  }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px; border-bottom:1px solid rgba(255,255,255,.08);
  }
  .mh-title{ font-weight:700; }
  .modal-body{
    padding:16px; display:flex; flex-direction:column; gap:12px; overflow:auto; flex:1;
    max-width:760px; width:100%; margin:0 auto;
  }
  .modal-footer{
    padding:12px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid rgba(255,255,255,.08);
  }
  .form-row{ display:flex; flex-direction:column; gap:6px; }
  .lbl{ font-size:12px; color:rgba(255,255,255,.7) }
  .req{ color:#ffb4b4; margin-left:4px }
  .input, .textarea{
    background:var(--surface-1,#161b28); color:var(--text);
    border:1px solid rgba(255,255,255,.12);
    border-radius:10px; padding:10px 12px;
  }
  .textarea{ min-height:120px; resize:vertical; }
  .help{ display:flex; justify-content:flex-end; font-size:12px; color:rgba(255,255,255,.6) }
  .alert.error{
    background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35);
    border-radius:10px; padding:8px 10px; color:#ffd1d1;
  }
  .btn{
    padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:transparent; color:var(--text); cursor:pointer;
  }
  .btn-primary{
    padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.1);
    background:var(--primary,#4f46e5); color:#fff; cursor:pointer; font-weight:600; min-width:110px;
  }
  .btn[disabled], .btn-primary[disabled]{ opacity:.6; cursor:not-allowed }
</style>

@code {
  [Parameter] public bool StartOpen { get; set; } = false;

  private int? _userId;
  private bool _open;
  private bool _loading = true;
  private string? _error;

  private int? _activeTopicId;
  private List<TopicItem> _followed = new();
  private List<TopicItem> _all = new();
  private HashSet<int> _busy = new();

  private bool _showCreate;
  private string _newTitle = string.Empty;
  private string _newDesc  = string.Empty;
  private string _createError = string.Empty;
  private bool _saving;
  private const int TitleMax = 80;

  private bool _canCreate =>
    !_saving &&
    !string.IsNullOrWhiteSpace(_newTitle) &&
    _newTitle.Trim().Length >= 3;

  protected override async Task OnInitializedAsync()
  {
    _open = StartOpen;

    var auth = await AuthStateProvider.GetAuthenticationStateAsync();
    var uidStr = auth.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    _userId = int.TryParse(uidStr, out var id) ? id : (int?)null;

    SetActiveFromUri(Nav.Uri);
    Nav.LocationChanged += OnLocationChanged;

    await RefreshAsync();
  }

  public void Dispose()
  {
    Nav.LocationChanged -= OnLocationChanged;
  }

  private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
  {
    SetActiveFromUri(e.Location);
    StateHasChanged();
  }

  private void SetActiveFromUri(string uri)
  {
    try
    {
      var baseUri = new Uri(uri);
      var segments = baseUri.AbsolutePath.Trim('/').Split('/', StringSplitOptions.RemoveEmptyEntries);
      if (segments.Length >= 2 && segments[0].Equals("topic", StringComparison.OrdinalIgnoreCase))
      {
        _activeTopicId = int.TryParse(segments[1], out var tid) ? tid : (int?)null;
      }
      else
      {
        _activeTopicId = null;
      }
    }
    catch
    {
      _activeTopicId = null;
    }
  }

  private async Task RefreshAsync()
  {
    _loading = true;
    _error = null;

    try
    {
      if (_userId is int uid)
      {
        var followed = await _topicService.GetFollowingAsync(uid);
        var followedSet = new HashSet<int>(followed.Select(t => t.Id));

        _followed = followed
          .Select(t => new TopicItem(t.Id, t.Title, IsFollowed: true, IsLocked: t.IsLocked))
          .ToList();

        var popular = await _topicService.GetForSidebarAsync(null);
        _all = popular
          .Select(t => new TopicItem(t.Id, t.Title, IsFollowed: followedSet.Contains(t.Id), IsLocked: t.IsLocked))
          .ToList();
      }
      else
      {
        var top = await _topicService.GetForSidebarAsync(null);
        _followed = new();
        _all = top.Select(t => new TopicItem(t.Id, t.Title, IsFollowed: false, IsLocked: t.IsLocked)).ToList();
      }
    }
    catch (Exception ex)
    {
      _error = ex.Message;
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }

  private void OpenDrawer() => _open = true;
  private void CloseDrawer() => _open = false;

  private Task MaybeCloseOnMobile()
  {
    if (_open) CloseDrawer();
    return Task.CompletedTask;
  }

  private Task NavigateToTopic(int id)
  {
    Nav.NavigateTo($"/topic/{id}", forceLoad: true);
    if (_open) CloseDrawer();
    return Task.CompletedTask;
  }

  private async Task FollowAsync(int topicId)
  {
    if (_userId is not int uid)
    {
      Nav.Login();
      return;
    }

    if (_busy.Contains(topicId)) return;
    _busy.Add(topicId);
    try
    {
      await _followService.FollowAsync(uid, topicId);
      await RefreshAsync();
    }
    catch (Exception ex)
    {
      _error = ex.Message;
    }
    finally
    {
      _busy.Remove(topicId);
      StateHasChanged();
    }
  }

  private async Task UnfollowAsync(int topicId)
  {
    if (_userId is not int uid)
    {
      Nav.Login();
      return;
    }

    if (_busy.Contains(topicId)) return;
    _busy.Add(topicId);
    try
    {
      await _followService.UnfollowAsync(uid, topicId);
      await RefreshAsync();
    }
    catch (Exception ex)
    {
      _error = ex.Message;
    }
    finally
    {
      _busy.Remove(topicId);
      StateHasChanged();
    }
  }

  private record TopicItem(int Id, string Title, bool IsFollowed = false, bool IsLocked = false);
  private void OpenCreateModal()
  {
    if (_userId is not int)
    {
      Nav.Login();
      return;
    }
    _createError = string.Empty;
    _newTitle = string.Empty;
    _newDesc = string.Empty;
    _showCreate = true;
  }

  private void CloseCreateModal()
  {
    if (_saving) return;
    _showCreate = false;
  }

  private async Task CreateTopicAsync()
  {
    _createError = string.Empty;

    if (_userId is not int uid)
    {
      Nav.Login();
      return;
    }

    var title = _newTitle?.Trim() ?? string.Empty;
    if (title.Length < 3)
    {
      _createError = "Title must be at least 3 characters.";
      return;
    }

    _saving = true;
    try
    {
      var topic = await _topicService.CreateAsync(title, _newDesc?.Trim(), uid);
      _showCreate = false;

      await RefreshAsync();
      await NavigateToTopic(topic.Id);
    }
    catch (Exception ex)
    {
      _createError = ex.Message;
    }
    finally
    {
      _saving = false;
      StateHasChanged();
    }
  }

  private void HandleModalKey(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e)
  {
    if (e.Key == "Escape")
    {
      CloseCreateModal();
    }
    else if ((e.CtrlKey || e.MetaKey) && e.Key == "Enter" && _canCreate)
    {
      _ = CreateTopicAsync();
    }
  }
}
