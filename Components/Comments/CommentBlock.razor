@using Microsoft.AspNetCore.Components
@using System.Security.Claims
@using LevelForum.Components.Other
@using Entities = LevelForum.Data.Entities
@using LevelForum.Data.Services
@using LevelForum.Infrastructure
@inject VoteService _voteService

<div class="comment @(Depth>0 ? "comment-child" : null)">
  <div class="c-vote">
    <button type="button"
            class="vote-btn up"
            aria-label="Upvote comment"
            aria-pressed="@(_myVote == 1 ? "true" : "false")"
            disabled="@IsVoteDisabled"
            @onclick="() => HandleVote(+1)">▲</button>

    <div class="c-score @( _myVote == 1 ? "is-up" : _myVote == -1 ? "is-down" : null)" aria-live="polite">@_score</div>

    <button type="button"
            class="vote-btn down"
            aria-label="Downvote comment"
            aria-pressed="@(_myVote == -1 ? "true" : "false")"
            disabled="@IsVoteDisabled"
            @onclick="() => HandleVote(-1)">▼</button>
  </div>

  <div class="c-main">
    <div class="c-header">
      <div class="c-avatar">@Initials(AuthorName)</div>
      <div class="c-meta">
        <span class="c-author">@AuthorName</span>
        <span class="c-dot">•</span>
        <time class="c-time" title="@CreatedAt.ToLocalTime().ToString("g")">@TimeAgo(CreatedAt)</time>
      </div>
      <span class="c-flex"></span>
      <ReportButton TargetType="Entities.ContentType.Comment"
                    TargetId="@Id"
                    ButtonTitle="Report comment"/>

      @if (IsOwn || CanModerate)
      {
        <div class="c-menu">
          <button type="button" class="icon-btn" aria-expanded="@_menuOpen" aria-haspopup="menu" @onclick="() => _menuOpen=!_menuOpen">⋮</button>
          @if (_menuOpen)
          {
            <div class="c-menu-pop" role="menu">
              @if (IsOwn)
              {
                <button type="button" class="c-menu-item" role="menuitem" @onclick="StartEdit">Edit</button>
                <button type="button" class="c-menu-item danger" role="menuitem" @onclick="() => OnDelete.InvokeAsync(Id)">Delete</button>
              }
              @if (CanModerate && !IsOwn)
              {
                <button type="button" class="c-menu-item danger" role="menuitem" @onclick="() => OnDelete.InvokeAsync(Id)">Remove</button>
              }
            </div>
          }
        </div>
      }
    </div>

    @if (_editing)
    {
      <div class="c-editor">
        <textarea class="composer-input" maxlength="@MaxChars" @oninput="e => _editText = e.Value?.ToString()" value="@_editText"></textarea>
        <div class="composer-bar">
          <div class="composer-count">@(_editText?.Length ?? 0)/@MaxChars</div>
          <div class="composer-actions">
            <button type="button" class="btn-ghost" @onclick="CancelEdit">Cancel</button>
            <button type="button" class="btn-primary" disabled="@string.IsNullOrWhiteSpace(_editText)" @onclick="SaveEdit">Save</button>
          </div>
        </div>
      </div>
    }
    else
    {
      <div class="c-text">@Body</div>
    }

    <div class="c-actions">
      @if (CanReply)
      {
        <button type="button" class="link-btn" @onclick="ToggleReply">Reply</button>
      }
    </div>

    @if (_replying)
    {
      <div class="c-reply">
        <CommentComposer CanPost="true"
                         Placeholder="Write a reply…"
                         MaxChars="@MaxChars"
                         ShowCancel="true"
                         OnCancel="ToggleReply"
                         OnSubmit="@(SubmitReply)" />
      </div>
    }

    @if (ChildComments?.Any() == true)
    {
      <div class="c-children">
        @foreach (var ch in ChildComments!)
        {
          <CommentBlock Id="@ch.Id"
                        AuthorName="@ch.AuthorName"
                        Body="@ch.Body"
                        CreatedAt="@ch.CreatedAt"
                        Score="@ch.Score"
                        MyVote="@ch.MyVote"
                        IsOwn="@ch.IsOwn"
                        CanModerate="@ch.CanModerate"
                        CanReply="false"
                        Depth="@(Depth+1)"
                        MaxChars="@MaxChars"
                        OnVote="OnVote"
                        OnReport="OnReport"
                        OnReply="OnReply"
                        OnEdit="OnEdit"
                        OnDelete="OnDelete"/>
        }
      </div>
    }
  </div>
</div>

@code{
  [CascadingParameter] protected Task<AuthenticationState>? authState { get; set; }
  protected ClaimsPrincipal UserClaims => authState?.Result.User ?? new();
  int? CurrentUserId => UserClaims.UserId();

  [Parameter] public int Id { get; set; }
  [Parameter] public string AuthorName { get; set; } = string.Empty;
  [Parameter] public string Body { get; set; } = string.Empty;
  [Parameter] public DateTime CreatedAt { get; set; }
  [Parameter] public int Score { get; set; }
  [Parameter] public int? MyVote { get; set; } // -1/0/+1
  [Parameter] public bool IsOwn { get; set; } = false;
  [Parameter] public bool CanModerate { get; set; } = false;
  [Parameter] public bool CanReply { get; set; } = true;
  [Parameter] public int Depth { get; set; } = 0; // 0=root, 1=child
  [Parameter] public int MaxChars { get; set; } = 2000;

  [Parameter] public IEnumerable<CommentVm>? ChildComments { get; set; }

  [Parameter] public EventCallback<(int commentId, int value)> OnVote { get; set; }
  [Parameter] public EventCallback<int> OnReport { get; set; }
  [Parameter] public EventCallback<(int parentId, string text)> OnReply { get; set; }
  [Parameter] public EventCallback<(int commentId, string text)> OnEdit { get; set; }
  [Parameter] public EventCallback<int> OnDelete { get; set; }

  bool _replying;
  bool _editing;
  string? _editText;
  bool _menuOpen;

  int _score;
  int? _myVote;
  bool _voteDisabled;

  bool IsVoteDisabled => _voteDisabled || !UserClaims.IsAuthenticated();

  protected override void OnParametersSet()
  {
    _score = Score;
    _myVote = MyVote;
  }

  async Task HandleVote(int v)
  {
    if (!UserClaims.IsAuthenticated()) return;

    var old = _myVote ?? 0;
    var next = (old == v) ? 0 : v;

    _voteDisabled = true;
    _myVote = next == 0 ? (int?)null : next;
    _score += (next - old);
    StateHasChanged();

    try
    {
      var newScore = await _voteService.ToggleVoteAsync(Entities.ContentType.Comment, Id, CurrentUserId!.Value, next);
      _score = newScore;
    }
    catch
    {
      _myVote = old == 0 ? (int?)null : old;
      _score -= (next - old);
    }
    finally
    {
      _voteDisabled = false;
      StateHasChanged();
    }

    if (OnVote.HasDelegate)
      await OnVote.InvokeAsync((Id, v));
  }

  void ToggleReply() => _replying = !_replying;

  Task SubmitReply(string text)
  {
    _replying = false;
    return OnReply.InvokeAsync((Id, text));
  }

  void StartEdit()
  {
    _editing = true;
    _menuOpen = false;
    _editText = Body;
  }

  void CancelEdit() => _editing = false;

  Task SaveEdit()
  {
    _editing = false;
    return OnEdit.InvokeAsync((Id, _editText ?? string.Empty));
  }

  static string Initials(string name)
  {
    if (string.IsNullOrWhiteSpace(name)) return "??";
    var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
    var letters = parts.Take(2).Select(p => char.ToUpperInvariant(p[0]));
    return new string(letters.ToArray());
  }

  static string TimeAgo(DateTime utc)
  {
    var dt = utc.ToLocalTime();
    var span = DateTime.Now - dt;
    if (span.TotalSeconds < 60) return "just now";
    if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m";
    if (span.TotalHours < 24) return $"{(int)span.TotalHours}h";
    if (span.TotalDays < 7) return $"{(int)span.TotalDays}d";
    return dt.ToString("yyyy-MM-dd");
  }

  public record CommentVm(
    int Id, string AuthorName, string Body, DateTime CreatedAt,
    int Score, int? MyVote, bool IsOwn, bool CanModerate);
}

<style>
  /* COMMENT */
  .comment{ display:flex; gap:10px; padding:12px; border-bottom:1px solid var(--border-color) }
  .comment-child{ background:rgba(255,255,255,.02); border-left:3px solid rgba(255,255,255,.08) }

  .c-vote{ width:46px; display:flex; flex-direction:column; align-items:center; gap:4px }
  .c-score{ min-width:24px; text-align:center; font-weight:600; color:var(--text) }

  .c-main{ flex:1; display:flex; flex-direction:column; gap:6px }
  .c-header{ display:flex; align-items:center; gap:8px }
  .c-avatar{ width:28px; height:28px; border-radius:50%; background:var(--surface-2);
    display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:var(--text) }
  .c-meta{ display:flex; align-items:center; gap:6px; color:var(--muted) }
  .c-author{ color:var(--text) } .c-dot{ opacity:.7 } .c-flex{ flex:1 }

  .c-menu{ position:relative }
  .c-menu-pop{ position:absolute; right:0; top:28px; min-width:140px; background:var(--surface);
    border:1px solid var(--border-color); border-radius:10px; box-shadow:0 12px 40px rgba(0,0,0,.35); padding:6px; z-index:20 }
  .c-menu-item{ width:100%; text-align:left; background:transparent; border:none; color:var(--text);
    padding:8px 10px; border-radius:8px; cursor:pointer }
  .c-menu-item:hover{ background:rgba(255,255,255,.06) }
  .c-menu-item.danger{ color:var(--on-danger); background:var(--danger) }

  .c-text{ color:var(--text); white-space:pre-wrap; line-height:1.5 }
  .c-actions{ display:flex; gap:10px }
  .link-btn{ background:transparent; border:none; color:var(--link); cursor:pointer; padding:0 }
  .link-btn:hover{ color:var(--link-hover); text-decoration:underline }

  /* Reply area and children */
  .c-reply{ margin-top:6px }
  .c-children{ margin-top:6px; display:flex; flex-direction:column; gap:0 }

  /* --- IDENTIČAN voting UI kao na PostList/PostHeader --- */
  .vote-btn{
    border:1px solid var(--border-color);
    background:transparent;
    border-radius:8px;
    width:34px; height:28px; cursor:pointer;
    transition: background-color .18s ease, border-color .18s ease, color .18s ease, transform .05s ease;
    outline: none; line-height:1;
  }
  .vote-btn:active{ transform: translateY(1px); }
  .vote-btn:focus-visible{
    box-shadow: 0 0 0 3px rgba(79,70,229,.35);
    border-color: var(--primary-light);
  }

  .vote-btn.up:hover{
    background: var(--success-lighter);
    color: var(--on-success-lighter);
    border-color: var(--success-light);
  }
  .vote-btn.down:hover{
    background: var(--danger-lighter);
    color: var(--on-danger-lighter);
    border-color: var(--danger-light);
  }

  .vote-btn.up[aria-pressed="true"]{
    color: var(--success);
    border-color: var(--success-dark);
  }
  .vote-btn.down[aria-pressed="true"]{
    color: var(--danger);
    border-color: var(--danger-dark);
  }
  .vote-btn.up[aria-pressed="true"]:hover{ border-color: var(--success-darker); }
  .vote-btn.down[aria-pressed="true"]:hover{ border-color: var(--danger-darker); }

  .vote-btn[disabled]{ opacity:.4; cursor:not-allowed; box-shadow:none; }

  .c-score.is-up{ color: var(--success-dark); }
  .c-score.is-down{ color: var(--danger-dark); }
</style>
