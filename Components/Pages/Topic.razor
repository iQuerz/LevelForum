@page "/topic/{Id:int}"
@using System.Security.Claims
@using LevelForum.Components.Layout
@using LevelForum.Components.Posts
@using LevelForum.Components.Other
@using LevelForum.Components.Shared
@using LevelForum.Data.Services
@using LevelForum.Infrastructure
@using Entities = LevelForum.Data.Entities

@inject PostService _postService
@inject TopicService _topicService
@inject VoteService _voteService

<PageContainer Title="@TopicToView.Title">
    <div class="app-card" style="padding:12px; display:flex; gap:8px; align-items:center;">
        <span class="chip">@TopicToView.Title</span>
        <FollowToggle IsFollowed="@_followed" OnChange="v => _followed = v" />
        <span style="flex:1"></span>
        <LockToggle Locked="@_locked" OnToggle="v => _locked = v" TopicId="Id" />
    </div>

    <div style="height:8px"></div>

    <ListToolbar SearchValue="@_q"
                 SearchValueChanged="v => _q = v"
                 OnSearch="DoSearch"
                 SortValue="@_sort"
                 SortValueChanged="v => _sort = v" />

    <PostList Items="@_items"
              IsLoading="@_loading"
              ShowLoadMore="@_hasMore"
              IsLoadingMore="@_loadingMore"
              OnLoadMore="LoadMore"
              OnVote="HandleVote"
              OnReport="HandleReport" />
</PageContainer>

@code{
    [CascadingParameter] protected Task<AuthenticationState>? authState { get; set; }
    protected ClaimsPrincipal UserClaims => authState?.Result.User ?? new();
    int? CurrentUserId => UserClaims.UserId();
    
    [Parameter] public int Id { get; set; }
    Entities.Topic TopicToView { get; set; } = new();
    
    private bool _followed = true;
    private bool _locked = false;

    private string? _q;
    private string _sort = "new";
    private bool _loading = true;
    private bool _loadingMore;
    private bool _hasMore = true;
    private int _page = 0;

    private List<PostList.PostListItem> _items = [];

    protected override async Task OnParametersSetAsync()
    {
        TopicToView = await _topicService.GetByIdAsync(Id);
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadMore();
    }

    private Task DoSearch(string? q)
    {
        _loading = true;
        StateHasChanged();
        _items = _items
            .Where(p => string.IsNullOrWhiteSpace(q) || p.Title.Contains(q!, StringComparison.OrdinalIgnoreCase))
            .ToList();
        _loading = false;
        return Task.CompletedTask;
    }

    private async Task LoadMore()
    {
        _loadingMore = true;
        StateHasChanged();
        
        var newItems = await _postService.QueryByTopicAsync(
            topicId: Id,
            titleQuery: null,
            sort: _sort,
            page: ++_page,
            userId: CurrentUserId,
            pageSize: 20);

        foreach (var item in newItems.Items)
        {
            _items.Add(new PostList.PostListItem(
                Id: item.Id,
                Title: item.Title,
                TopicId: item.TopicId,
                TopicTitle: item.Topic.Title,
                AuthorName: item.Author.Username,
                CreatedAt: item.CreatedAt,
                Score: item.Score,
                MyVote: item.MyVote,
                CommentsCount: 0,
                TopicLocked: item.Topic.IsLocked,
                VoteDisabled: item.IsDeleted || item.Topic.IsLocked));
        }
        
        _hasMore = true;
        _loadingMore = false;
    }

    private async Task HandleVote((int postId, int value) ev)
    {
        var idx = _items.FindIndex(p => p.Id == ev.postId);
        if (idx < 0 || !UserClaims.IsAuthenticated()) return;

        var it = _items[idx];
        var oldVote = it.MyVote ?? 0;
        var next = (oldVote == ev.value) ? 0 : ev.value;

        _items[idx] = it with
        {
            VoteDisabled = true,
            MyVote = next == 0 ? (int?)null : next,
            Score = it.Score + (next - oldVote)
        };
        StateHasChanged();

        try
        {
            // Server vraća zbir glasova nakon izmene
            // (pretpostavka: ContentType.Post jer smo na /topic listi postova)
            var newScore = await _voteService.ToggleVoteAsync(Entities.ContentType.Post, ev.postId, UserClaims.UserId().Value, next);

            _items[idx] = _items[idx] with
            {
                Score = newScore,
                VoteDisabled = false
            };
        }
        catch
        {
            // Greška -> vrati stari prikaz
            _items[idx] = it;
        }
        finally
        {
            StateHasChanged();
        }
    }


    private Task HandleReport(int postId) => Task.CompletedTask;
}
